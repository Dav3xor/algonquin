<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="stylesheet" href="/static/bootstrap.min.css">

    <title>{{ config.site_name }}</title>
  </head>

  <body>
    <h1> Hello </h1>
    <div id="login" style="display:none;">
      <form onsubmit="return false;">
        <input type="text" name="email" placeholder="Email" id="email" required>
        <input type="password" name="password" id="password" placeholder="Password" required>
        <button onclick="send_login_email();" type="button">Login</button>
      </form>
      <canvas id="lissajous" width="150" height="150"></canvas>
    </div>

    <div id="logout" style="display:none;">
      <button onclick="logout();" type="button">Logout</button>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" 
            integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" 
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" 
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" 
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" 
            crossorigin="anonymous"></script>


    <script type="text/javascript" charset="utf-8">
        function qs(selector) {
          return document.querySelector(selector);
        }
        function qsv(selector) {
          return document.querySelector(selector).value;
        }

        var cookie = {
          write : function (cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires="+d.toUTCString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
          },
          read : function (name) {
            if (document.cookie.indexOf(name) > -1) {
              return document.cookie.split(name)[1].split("; ")[0].substr(1)
            } else {
              return "";
            }
          },
          delete : function (cname) {
            var d = new Date();
            d.setTime(d.getTime() - 1000);
            var expires = "expires="+d.toUTCString();
            document.cookie = cname + "=; " + expires;
          }
        };


        var socket = io();
        window.requestAnimationFrame(lissajous);
  
        var canvas = document.getElementById('lissajous');
        var ctx = canvas.getContext('2d');
        ctx.strokeStyle = 'rgb(50,200,100)';
        ctx.lineWidth = 2;
        var lissajous_counter = 0;
        function lissajous() {
          a=2;//1;
          b=3;//3;
          var time = new Date();
          //delta = 3.14159/2.0+.1;
          delta = lissajous_counter;
          lissajous_counter += .012;
          ctx.clearRect(0,0,150,150);
          ctx.beginPath()
          ctx.moveTo(75+50*Math.sin(delta), 75);
          for(i=0;i<131;i++) {
            angle = ((3.14159*2)/131.0)*i;
            x = 75 + 50*Math.sin(a*angle+delta);
            y = 75 + 50*Math.sin(b*angle);
            ctx.lineTo(x,y);
          }
          ctx.closePath();
          ctx.stroke();
          window.requestAnimationFrame(lissajous);
        }


        socket.on('connect', function() {
          sessionid = cookie.read('sessionid');
          if (sessionid != '') {
            socket.emit('login-session', {sessionid: sessionid});
          } else {
            qs('#login').style.display = 'block';
          }
        });

        function send_login_email() {
          email = qsv('#email');
          password = qsv('#password');
          socket.emit('login-email', {email: email, password: password});
        }

        function logout() {
            qs('#logout').style.display = 'none';
            qs('#login').style.display = 'block';
            cookie.delete('sessionid')
        }

        socket.on('login-result', data => {
          console.log(data);
          if(data.authenticated) {
            qs('#logout').style.display = 'block';
            qs('#login').style.display = 'none';
            if ('sessionid' in data) {
              cookie.write('sessionid', data.sessionid, 365);
            }
          }
            
        });
    </script>

  </body>
</html>

