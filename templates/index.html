<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="stylesheet" href="/static/bootstrap.min.css">

    <title>{{ config.site_name }}</title>
  </head>

  <body>
    <h1> Hello </h1>
    <div id="login" style="display:none;">
      <form onsubmit="return false;">
        <input type="text" name="email" placeholder="Email" id="email" required>
        <input type="password" name="password" id="password" placeholder="Password" required>
        <button onclick="send_login_email();" type="button">Login</button>
      </form>
    </div>

    <div id="logout" style="display:none;">
      <button onclick="logout();" type="button">Logout</button>
    </div>
    <canvas id="lissajous" width="150" height="150"></canvas>

    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" 
            integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" 
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" 
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" 
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" 
            crossorigin="anonymous"></script>


    <script type="text/javascript" charset="utf-8">
        function qs(selector) {
          return document.querySelector(selector);
        }
        function qsv(selector) {
          return document.querySelector(selector).value;
        }

        var cookie = {
          write : function (cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires="+d.toUTCString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
          },
          read : function (name) {
            if (document.cookie.indexOf(name) > -1) {
              return document.cookie.split(name)[1].split("; ")[0].substr(1)
            } else {
              return "";
            }
          },
          delete : function (cname) {
            var d = new Date();
            d.setTime(d.getTime() - 1000);
            var expires = "expires="+d.toUTCString();
            document.cookie = cname + "=; " + expires;
          }
        };

        class Lissajous {
          constructor(canvas, height, width) {
            this.canvas  = canvas;
            this.height  = height;
            this.width   = width;
            this.counter = 0;
            this.a       = 2;
            this.b       = 3;
            this.agoal   = 2;
            this.bgoal   = 3;
            this.ctx     = canvas.getContext('2d');
            this.draw();
          }
          seta(newval) {
            this.agoal=newval;
          }
          setb(newval) {
            this.bgoal=newval;
          }
          draw() {
            var time = new Date();
            var delta = this.counter;
            this.counter += .012;
            this.ctx.clearRect(0,0,150,150);
            this.ctx.beginPath()
            this.ctx.moveTo(75+50*Math.sin(delta), 75);
            if (this.a != this.agoal) {
              this.a += (this.agoal-this.a)*0.05;
            }
            if (this.b != this.bgoal) {
              this.b += (this.bgoal-this.b)*0.05;
            }
            for(var i=0;i<131;i++) {
              var angle = ((3.14159*2)/131.0)*i;
              var x = 75 + 50*Math.sin(this.a*angle+delta);
              var y = 75 + 50*Math.sin(this.b*angle);
              this.ctx.lineTo(x,y);
            }
            this.ctx.closePath();
            this.ctx.stroke();
            window.requestAnimationFrame(this.draw.bind(this));
          }
        }

        var socket = io();
  
        var canvas = document.getElementById('lissajous');
        var ctx = canvas.getContext('2d');
        ctx.strokeStyle = 'rgb(50,200,100)';
        ctx.lineWidth = 2;
        var lissajous = new Lissajous(canvas, 150,150);

        socket.on('connect', function() {
          sessionid = cookie.read('sessionid');
          if (sessionid != '') {
            socket.emit('login-session', {sessionid: sessionid});
          } else {
            qs('#login').style.display = 'block';
          }
        });

        function send_login_email() {
          email = qsv('#email');
          password = qsv('#password');
          socket.emit('login-email', {email: email, password: password});
        }

        function logout() {
            qs('#logout').style.display = 'none';
            qs('#login').style.display = 'block';
            cookie.delete('sessionid');
            lissajous.setb(5);
        }

        socket.on('login-result', data => {
          console.log(data);
          if(data.authenticated) {
            qs('#logout').style.display = 'block';
            qs('#login').style.display = 'none';
            if ('sessionid' in data) {
              cookie.write('sessionid', data.sessionid, 365);
            }
            lissajous.setb(4);
          } else {
            lissajous.setb(1);
            lissajous.seta(1);
          }

            
        });
    </script>

  </body>
</html>

