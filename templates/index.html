<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="/static/algonquin.css">

    <title>{{ config.site_name }}</title>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="navbar" style="display:none;">
      <a class="navbar-brand" href="#">
        <span><canvas id="lissajous" width=30 height=30></canvas></span>
        Algonquin
      </a>
      <button class="navbar-toggler" type="button"
              data-toggle="collapse" data-target="#navb" aria-expanded="false">
        <span class="navbar-toggler-https://hobbyking.com/en_us/h-king-bixler-2-epo-1500mm-pnp.htmlicon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navb">
        <ul class="navbar-nav mr-auto" style="padding-top:1.2rem">
          <li class="nav-item dropdown active" id="messages_nav">
            <a class="nav-link dropdown-toggle" data-toggle="dropdown" id="messages_label">messages</a>
            <div class="dropdown-menu" aria-labelledby="room_list" id="room_list">
            </div>
          </li>
          <li class="nav-item" id="people-nav">
            <a class="nav-link">people</a>
          </li>
          <li class="nav-item" id="images-nav">
            <a class="nav-link">images</a>
          </li>
          <li class="nav-item" id="audio-nav">
            <a class="nav-link">audio</a>
          </li>
          <li class="nav-item" id="search-nav">
            <a class="nav-link">search</a>
          </li>
          <li class="nav-item" id="about-nav">
            <a class="nav-link">about</a>
          </li>
          <li class="nav-item" id="settings-nav">
            <a class="nav-link">settings</a>
          </li>
        </ul>
        <form class="form-inline" id="logout">
            <button class="btn btn-warning btn-sm" onclick="send_logout();" type="button">Logout</button>
        </form>
      </div>

    </nav>
    <div id="footer" style="display:none;" class="navbar navbar-dark bg-dark fixed-bottom">
      <form class="form-inline" id="write_message">
        <input id="new-message" class="form-control" type="text" placeholder="Say Something" aria-label="Enter Message">
        <button class="btn btn-success btn-sm" onclick="send_message();" type="button">
          Send
          <svg width="1em" height="2em" viewBox="0 0 16 16" class="bi bi-chat-text" 
               fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 
                                         2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 
                                         8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 
                                         4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 
                                         21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 
                                         0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 
                                         11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 
                                         7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
            <path fill-rule="evenodd" d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM4 
                                         8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8zm0 
                                         2.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5z"/>
          </svg>
        </button>
      </form>
    </div>

    <div id="login" class="modal" tabindex="-1">
      <div class="modal-dialog modal-light">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Login</h5>
          </div>
          <div class="modal-body">
            <div class="login-banner">
              {{ config.site_name }}
            </div>
            <form "form-inline" onsubmit="return false;">
              <div class="form-group">
                <label for="email">Email:</label>
                <input type="text" class="form-control" name="email" placeholder="Email" id="email" required>
              </div>
              <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" class="form-control" name="password" id="password" placeholder="Password" required>
              </div>
              <div class="pb-2"><button onclick="send_login_email();" type="button" class="btn btn-success btn-sm">Login</button></div>
            </form>
            <div class="modal-footer">
              <div class="float-right"> 
                <span class="badge badge-secondary badge-dark">
                  <div class="float-right">Brought to you by:</div>
                  <div class="login-logo-banner"><a href="https://www.github.com/Dav3xor/algonquin">Algonquin</a></div>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid d-none" id="messages">
    </div>

    <div class="container-fluid" id="invite">
      <form "form-inline" autocomplete="off" onsubmit="return false;">
        <div class="row">
          <div class="col">
            <div class="form-group">
              <label for="invite-message">Message:</label>
              <textarea class="form-control" name="invite-message" id="invite-message" rows="20"></textarea>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label for="invite-email">New User Email:</label>
              <input autocomplete="nope" type="text" class="form-control" name="invite-email" id="invite-email" required>
            </div>
            <div class="form-group">
              <label for="invite-handle">New User Handle:</label>
              <input type="text" class="form-control" name="invite-handle" id="invite-handle" required>
            </div>
            <div class="form-group">
              <label for="password">New User Password:</label>
              <input autocomplete="new-password" type="password" class="form-control" name="invite-password" id="invite-password">
              <div><b>Note:</b> You can leave the password blank, and the user can enter it in later.</div>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="invite-send-email">
              <label class="form-check-label" for="send-email">Send Email Invite</label>
            </div>
            <div class="pb-2">
              <button onclick="invite.create_user();" 
                      type="button" 
                      class="btn btn-success btn-lg">
                Add User
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="container-fluid" id="invite-result">
      <div class="row">
        <div class="col-4"><h1>Invite Result:</h1></div>
        <div class="col=8"><div class="alert alert-danger">User Created Successfully</div></div>
      </div>
      <div class="row">
        <div class="col-2">
          Message:
        </div>
        <div class="col-7">
          <div class="alert alert-dark" 
               role="alert" 
               id="invite-result">
            message text
          </div>
        </div>
        <div class="col-3">
          <button class="btn btn-light btn-lg">Copy to Clipboard</button>
        </div>
      </div>
      <div class="row">
        <div class="col-2">
          Bare Url:
        </div>
        <div class="col-7">
          <div class="alert alert-dark" 
               role="alert" 
               id="invite-result">
            message text
          </div>
        </div>
        <div class="col-3">
          <button class="btn btn-light btn-lg">Copy to Clipboard</button>
        </div>
      </div>
    </div>    
    
    <canvas id="lissajous2" width="150" height="150"></canvas>

    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" 
            integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" 
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" 
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" 
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" 
            crossorigin="anonymous"></script>
    <script src="/static/showdown.js"></script>

    <script type="text/javascript" charset="utf-8">
        function qsv(selector) {
          return document.querySelector(selector).value;
        }


        class Invite {
          constructor() { 
          }
          create_user() {
            var email      = $('#invite-email').val();
            var password   = $('#invite-password').val();
            var message    = $('#invite-message').val();
            var handle     = $('#invite-handle').val();
            var send_email = $('#invite-send-email').val();
            var message = {email: email,
                           password: password,
                           message: message,
                           handle: handle,
                           send_email: send_email};

            socket.emit('invite-new-user', message);
          }
        }

        class Messages {
          constructor() {
            var cur_room = cookie.read('cur_room');
            if(cur_room != "") {
              this.cur_room = cur_room;
            } else {
              this.cur_room = "1";
            }
            this.rooms = {};
          }

          change_room(room) {
            this.cur_room = room;
            cookie.write('cur_room', room, '365');
            this.render();
            this.render_room_list();
          }
          
          build_rooms(rooms) {
            for (let room of rooms) {
              this.rooms[room.id] = room;
              this.rooms[room.id].messages = [];
            }
          }

          render_room_list() {
            $('#room_list').empty();
            for (var room in this.rooms) {
              room = this.rooms[room];
              if ( room.id != this.cur_room ) {
                $('#room_list').append('<a class="dropdown-item" href="#" onclick="messages.change_room(\''+room.id+'\');">'+room.name+'</a>');
              } else {
                $('#messages_label').html(this.rooms[this.cur_room].name);
              }

            }
          }

          render() {
            $('#messages').empty();
            for (let message of this['rooms'][this.cur_room]['messages']) {
              this.render_message(message);
            }
          }

          render_message(message) {
            $('#messages').append('<div class="row"> <div class="col"><img src="/static/user-'+
                                  message.user+'.png" width=30 /><b>' + 
                                  scoreboard[message.user].handle + 
                                  '</b></div> <div class="col-10">' + 
                                  markdown.makeHtml(message.message) + 
                                  '</div> </div>');
          }
            
          add(message) {
            if (!this.rooms.hasOwnProperty(message.room)) {
              this.rooms[message.room] = { messages:[] };
            }
            this.rooms[message.room].messages.push(message);
            if (message.room == this.cur_room){
              this.render_message(message);
            }
          }
        }
            
        var cookie = {
          write : function (cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires="+d.toUTCString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
          },
          read : function (name) {
            if (document.cookie.indexOf(name) > -1) {
              return document.cookie.split(name)[1].split("; ")[0].substr(1)
            } else {
              return "";
            }
          },
          delete : function (cname) {
            var d = new Date();
            d.setTime(d.getTime() - 1000);
            var expires = "expires="+d.toUTCString();
            document.cookie = cname + "=; " + expires;
          }
        };

        class Lissajous {
          constructor(canvas, width, height) {
            this.canvas  = canvas;
            this.height  = height;
            this.width   = width;
            this.counter = 0;
            this.a       = 2;
            this.b       = 3;
            this.agoal   = 2;
            this.bgoal   = 3;
            this.ctx     = canvas.getContext('2d');
            this.draw();
          }
          seta(newval) {
            this.agoal=newval;
          }
          setb(newval) {
            this.bgoal=newval;
          }
          draw() {
            var time = new Date();
            var delta = this.counter;
            this.counter += .012;
            this.ctx.clearRect(0,0,this.width, this.height);
            this.ctx.beginPath();
            this.ctx.moveTo((this.width/2)+(this.width/2.1)*Math.sin(delta), (this.height/2));
            if (this.a != this.agoal) {
              this.a += (this.agoal-this.a)*0.05;
            }
            if (this.b != this.bgoal) {
              this.b += (this.bgoal-this.b)*0.05;
            }
            for(var i=0;i<131;i++) {
              var angle = ((3.14159*2)/131.0)*i;
              var x = (this.width/2) + (this.width/2.1)*Math.sin(this.a*angle+delta);
              var y = (this.height/2) + (this.height/2.1)*Math.sin(this.b*angle);
              this.ctx.lineTo(x,y);
            }
            this.ctx.closePath();
            this.ctx.stroke();
            window.requestAnimationFrame(this.draw.bind(this));
          }
        }

        $('.dropdown-toggle').dropdown();
        $(".navbar-nav .nav-item .nav-link").on("click", function(){
           $(".nav-item").removeClass("active");
           $(this).parent().addClass("active");
        });

        var socket = io({rememberTransport: false});
 
        var canvas = document.getElementById('lissajous');
        var ctx = canvas.getContext('2d');
        ctx.strokeStyle = 'rgb(50,200,100)';
        ctx.lineWidth = 2;
        var lissajous = new Lissajous(canvas, 30, 30);
        var messages  = new Messages();
        var invite    = new Invite();

        var scoreboard = {users:{}};

        var markdown = new showdown.Converter({'simplifiedAutoLink':true, 'openLinksInNewWindow':true});

        socket.on('connect', function() {
          var sessionid = cookie.read('sessionid');
          if (sessionid != '') {
            socket.emit('login-session', {sessionid: sessionid});
          } else {
            $('#login').show();
          }
        });

        function send_login_email() {
          var email = qsv('#email');
          var password = qsv('#password');
          socket.emit('login-email', {email: email, password: password});
        }
        function send_message() {
          var message = $('#new-message').val();
          socket.emit('message', {message:message, room:parseInt(messages.cur_room)});
          $('#new-message').val("");
        }

        function send_logout() {
            $('#navbar').hide();
            $('#footer').hide();
            $('#login').show();
            $('#messages').empty();
            var sessionid = cookie.read('sessionid');
            cookie.delete('sessionid');
            socket.emit('logout', {sessionid: sessionid});
            lissajous.setb(5);
        }

        socket.on('login-result', data => {
          console.log(data);
          if(data.authenticated) {
            $('#navbar').show();
            $('#footer').show();
            $('#login').hide();
            if ('sessionid' in data) {
              cookie.write('sessionid', data.sessionid, 365);
            }
            lissajous.setb(4);
          } else {
            $('#login').show();
            cookie.delete('sessionid');
            lissajous.setb(1);
            lissajous.seta(1);
          }
        });
      
        socket.on('invite-result', data => {


        });

        socket.on('messages', data => {
          for (let message of data['messages'].reverse()) {
            messages.add(message);
          }
        });

        socket.on('memberships', data => {
          messages.build_rooms(data);
          messages.render_room_list();
        });
          
        socket.on('user_list', data => {
          for (user in data) {
            scoreboard[user] = data[user];
          }
        });

        socket.on('user_info', data => {
          scoreboard[data.id] = data;
        });
          
    </script>

  </body>
</html>

